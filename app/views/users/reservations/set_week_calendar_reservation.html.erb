<div class="container">
    <h3>ご希望の来店日時を選択してください</h3>
    <%= link_to "月間カレンダーへ", users_set_month_calendar_reservation_path(menu_id: @menu.id), class: "to_month_calendar" %>

    <!--ここからmenuカード-->
    <div class="menu_card2" style="margin: 0 auto; margin-top: 15px;">
        <div class="menu_top" >
            <div>
                <%= link_to users_hairdresser_path(@menu.hairdresser.id), remote: true do %>
                    <%= attachment_image_tag @menu.hairdresser, :hairdresser_image, size: "70x70", fallback: "no_image.png", class: "img-circle face_img" %>
                <% end %>

                <!-- 美容師のshowモーダルを表示するための記述 -->
                <div id="hairdresser_show" class="sign_up_in"></div>
                <!-- 美容師のshowモーダルを表示するための記述 ここまで-->

                <span class="title2 font"><%= @menu.name %></span>
                <span class="menu_time2 font"><%= @menu.time %>分</span>
                <% if @menu.category[0,1] == "1" %>
                    <span class="cut_category category font">カット</span>
                <% end %>
                <% if @menu.category[1,1] == "1" %>
                    <span class="color_category category font">カラー</span>
                <% end %>
                <% if @menu.category[2,1] == "1" %>
                    <span class="curly_category category font">縮毛矯正</span>
                <% end %>
                <% if @menu.category[3,1] == "1" %>
                    <span class="perm_category category font">パーマ</span>
                <% end %>
                <div style="margin-left: 15px;"><%= @menu.hairdresser.name %></div>
                <div class="star-rate-<%= @menu.hairdresser.id %>"></div>
                    <!-- 星をつけるための記述 -->
                    <% @comments = @menu.hairdresser.hairdresser_comments.where.not(rate: nil).count %>
                        <script>
                            $('.star-rate-<%= @menu.hairdresser.id %>').raty({
                                size: 36,
                                starOff:  '<%= asset_path('star-off.png') %>',
                                starOn : '<%= asset_path('star-on.png') %>',
                                starHalf: '<%= asset_path('star-half.png') %>',
                                half: true,
                                readOnly: true,
                                //reputation_pointは評価ポイント(星)の合計　@commentsはコメントの数(評価ポイントをくれた人の人数) この二つで平均を出す　
                                score: <%= @menu.hairdresser.reputation_point %>/<%= @comments %>,
                            });
                            //sizeを変えてもsize変わらなかったのでここで記述する
                            $('.star-rate-<%= @menu.hairdresser.id %>').children("img").css({
                                "width": "13px"
                            })
                            $('.star-rate-<%= @menu.hairdresser.id %>').children("img").eq(0).css({
                                "margin-left": "5px"
                            })
                        </script>
                    <!-- 星をつけるための記述 ここまで -->
            </div>
        </div>
        <div class="menu_bottom2">
            <%= attachment_image_tag @menu, :menu_image, fallback: "no_image.png", id: "prev_menu_img" %>
            <div class="explain font"><%= @menu.explanation %></div>
        </div>
    </div>

    <div class="explain_simbol">
        <span style="color: red;" class="simbol">◎</span>予約可能
        <span style="color: blue;" class="simbol">△</span>キャンセル待ち
        <span class="glyphicon glyphicon-remove simbol" aria-hidden="true"></span>予約不可
    </div>

    <!--ここから週間カレンダー-->
    <table class="week_reservation_table">
        <thead class="table_header" id="table_head">
         
            <tr>
                <!--前の週-->
                <% if @standard_day != Date.today %>
                    <th rowspan="2" class="border_right border_bottom2 width1"><%= link_to "前の一週間", users_set_week_calendar_reservation_path(option: "last", day: @standard_day, menu_id: @menu.id), class: "last_week" %></th>
                <% else %> <!--linkを無効-->
                    <th rowspan="2" class="border_right border_bottom2 width1 add1"><%= link_to "前の一週間", users_set_week_calendar_reservation_path(option: "last", day: @standard_day, menu_id: @menu.id), style: "pointer-events: none; color: grey;" %></th>
                <% end %>
                <!--年月-->
                <% if  @diff >= 13%>
                    <th colspan="14" class="border_righ border_botto width2 height2 "><%= @standard_day.year %>年<%= @standard_day.month %>月</th>
                <% else %>
                    <% if @diff + 1 >= 4 %>
                        <th width="43" height="45" colspan="<%= @diff + 1 %>" class="border_right border_botto height2 "><%= @standard_day.year %>年<%= @standard_day.month %>月</th>
                    <% else %>
                        <th width="43" height="45" colspan="<%= @diff + 1 %>" class="border_right border_botto height2 "></th>
                    <% end %>
                    <% if 13 - @diff >= 4 %>
                        <th width="43" height="45" colspan="<%= 13 - @diff  %>" class="border_righ border_botto height2 "><%= @standard_day.next_month.year %>年<%= @standard_day.next_month.month %>月</th>
                    <% else %>
                        <th width="43" height="45" colspan="<%= 13 - @diff  %>" class="border_righ border_botto height2 "></th>
                    <% end %>
                <% end %>
                <!--次の週-->
                <th rowspan="2" class="attr87 width1 add1 border_bottom2 border_left"><%= link_to "次の一週間", users_set_week_calendar_reservation_path(option: "next", day: @standard_day, menu_id: @menu.id), class: "next_week" %></th>
            </tr>
            <tr>
                <% for i in 0..13 do %>
                    <% @day = @standard_day + i %>
                    <% if HolidayJp.holiday?(@day).present? %>
                        <th class="border_left border_bottom2 border_top width3 holiday_back2">
                            <div class="holiday2"><%= (@standard_day + i).day %></div>
                            <div class="holiday2">(祝)</div>
                        </th>
                    <% elsif @day.wday == 6 %>
                        <th class="border_left border_bottom2 border_top width3 holiday_back1">
                            <div class="holiday1"><%= (@standard_day + i).day %></div>
                            <div class="holiday1">(<%= %w(日 月 火 水 木 金 土)[(@standard_day+i).wday] %>)</div>
                        </th>
                    <% elsif @day.wday == 0 %>
                        <th class="border_left border_bottom2 border_top width3 holiday_back2">
                            <div class="holiday2"><%= (@standard_day + i).day %></div>
                            <div class="holiday2">(<%= %w(日 月 火 水 木 金 土)[(@standard_day+i).wday] %>)</div>
                        </th>
                    <% else %>
                        <th class="border_left border_bottom2 border_top width3">
                            <%= (@standard_day + i).day %>
                            <div>
                            (<%= %w(日 月 火 水 木 金 土)[(@standard_day+i).wday] %>)
                            </div>
                        </th>
                    <% end %>
                <% end %>
            </tr>
           
        </thead>
        <tbody id="table_body">
            <tr>
                <!--左の時刻表-->
                <th class="border_right table_time">
                    <table>
                        <% i = 0 %>
                        <% @time_arry.each do |time| %>
                            <% if i % 2 == 0 %> 
                                <tr>
                                    <th style="font-size: 18px;" class="border_bottom width4"><%= time %></th>
                                </tr>
                            <% else %>
                                <tr>
                                    <th style="font-size: 15px;" class="border_bottom2 width4"><%= time %></th>
                                </tr>
                            <% end %>
                            <% i += 1 %>
                        <% end %>
                    </table>
                </th>
                
                <!--バツマル-->
                <% for x in 1..14 do %>
                    <th class="border_right">
                        <!--このテーブルは縦一列-->
                        <table>
                            <% i = 0 %>
                            <% @key = 0 %>
                            <% @day_arry.each do |date| %>
                                <!--基準となる日付を決める-->
                                <% if x == 1 && @key == 0%>
                                    <% @key_day = @day_arry[0] %>
                                    <% @key = 1 %>
                                <% elsif x >= 2 && @key == 0%>
                                    <% if @key_day.day != date.day && @key_day < date %>
                                        <% @key_day = date %>
                                        <% @key = 1 %>
                                    <% end %>
                                <% end %>

                                <!--基準となる日付が決まったらtd要素を作成-->
                                <% if @key == 1 %>
                                    <% break if @key_day.day != date.day && @key_day < date %> <!--日付が変わったらループ終了 例 1/1 23:30 で次が1/2 06:00だったら 1/2 のdateで打ち切る-->
                                
                                    <% if i % 2 == 0 %> <!--偶数番目の列はboreser-bottomが1px-->
                                        <tr>
                                            <td class="border_bottom width3 td_color">
                                                <% if Reservation.find_by(start_time: date, menu_id: @menu.id).present? %>
                                                    <% @reservation = Reservation.find_by(start_time: date, menu_id: @menu.id) %>
                                                    <% @time_min = @reservation.start_time %>
                                                    <% @time_max = @reservation.start_time  + @reservation.menu.time*60 - 1 %>
                                                    <% @reservation_after = Reservation.where(start_time: @time_min..@time_max, status: 1) %>
                                                    <% if @reservation_after.blank? %>
                                                        <%= link_to edit_users_reservation_path(@reservation.id) do %>
                                                            <p style="color: red;" class="simbol_round">◎</p>
                                                        <% end %>
                                                    <% else %>
                                                        <p style="color: blue;" class="simbol_triangle">△</p>
                                                    <% end %>
                                                <% else %>
                                                    <span class="glyphicon glyphicon-remove simbol_remove" aria-hidden="true"></span>
                                                <% end %>
                                            </td>
                                        </tr>
                                    <% else %> <!--奇数番目の列はboreser-bottomが3px-->
                                        <tr>
                                            <td class="border_bottom2 width3 td_color">
                                                <% if Reservation.find_by(start_time: date, menu_id: @menu.id).present? %>
                                                    <% @reservation = Reservation.find_by(start_time: date, menu_id: @menu.id) %>
                                                    <% @time_min = @reservation.start_time %>
                                                    <% @time_max = @reservation.start_time  + @reservation.menu.time*60 - 1 %>
                                                    <% @reservation_after = Reservation.where(start_time: @time_min..@time_max, status: 1) %>
                                                    <% if @reservation_after.blank? %>
                                                        <%= link_to edit_users_reservation_path(@reservation.id) do %>
                                                            <p style="color: red;" class="simbol_round">◎</p>
                                                        <% end %>
                                                    <% else %>
                                                        <p style="color: blue;" class="simbol_triangle">△</p>
                                                    <% end %>
                                                <% else %> 
                                                    <span class="glyphicon glyphicon-remove simbol_remove" aria-hidden="true"></span>
                                                <% end %>
                                            </td>
                                        </tr>
                                    <% end %>
                                <% end %>
                                <% i += 1 %>
                            <% end %>
                        </table>
                    </th>
                <% end %>
                
                <!--右の時刻表-->
                <th class="table_time">
                    <table>
                        <% i = 0 %>
                        <% @time_arry.each do |time| %>
                            <% if i % 2 == 0 %>
                                <tr>
                                    <th style="font-size: 18px;" class="border_bottom width4"><%= time %></th>
                                </tr>
                            <% else %>
                                <tr>
                                    <th style="font-size: 15px;" class="border_bottom2 width4"><%= time %></th>
                                </tr>
                            <% end %>
                            <% i += 1 %>
                        <% end %>
                    </table>
                </th>
            </tr>
        </tbody>
    </table>
    
</div>
